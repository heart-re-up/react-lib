import { useDownload } from "@heart-re-up/react-lib/hooks/useDownload";
import { Badge, Button, Card, Flex, Text, TextField } from "@radix-ui/themes";
import { useRef, useState } from "react";
import {
  drawChartImage,
  drawGradientImage,
  drawPatternImage,
  drawQRImage,
} from "./drawImage";

export default function DemoImage() {
  const [filename, setFilename] = useState("generated-image.png");
  const [downloadStatus, setDownloadStatus] = useState<string>("");
  const canvasRef = useRef<HTMLCanvasElement>(null);

  const { download } = useDownload();

  const generateAndDrawImage = (
    type: "gradient" | "chart" | "pattern" | "qr"
  ) => {
    const canvas = canvasRef.current;
    if (!canvas) {
      console.warn("canvas is not found");
      return;
    }
    switch (type) {
      case "gradient":
        drawGradientImage(canvas);
        break;
      case "chart":
        drawChartImage(canvas);
        break;
      case "pattern":
        drawPatternImage(canvas);
        break;
      case "qr":
        drawQRImage(canvas);
        break;
    }
  };

  const handleDownloadCanvas = async () => {
    const canvas = canvasRef.current;
    if (!canvas) {
      console.warn("canvas is not found");
      return;
    }

    canvas.toBlob(async (blob) => {
      if (blob) {
        const success = await download(blob, { filename });
        setDownloadStatus(success ? "ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì„±ê³µ!" : "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");
        setTimeout(() => setDownloadStatus(""), 3000);
      }
    }, "image/png");
  };

  const downloadSVGImage = async () => {
    const svg = `
      <svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
          </linearGradient>
        </defs>
        <rect width="300" height="200" fill="url(#bg)" rx="15"/>
        <text x="150" y="80" font-family="Arial" font-size="24" font-weight="bold" 
              fill="white" text-anchor="middle">SVG Image</text>
        <text x="150" y="110" font-family="Arial" font-size="16" 
              fill="rgba(255,255,255,0.8)" text-anchor="middle">Generated by useDownload</text>
        <circle cx="150" cy="140" r="20" fill="rgba(255,255,255,0.3)"/>
        <rect x="130" y="160" width="40" height="20" fill="rgba(255,255,255,0.2)" rx="10"/>
      </svg>
    `;

    const blob = new Blob([svg], { type: "image/svg+xml" });
    const success = await download(blob, {
      filename: filename.replace(".png", ".svg"),
    });

    setDownloadStatus(success ? "SVG ë‹¤ìš´ë¡œë“œ ì„±ê³µ!" : "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");
    setTimeout(() => setDownloadStatus(""), 3000);
  };

  // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ê¸°ë³¸ ì´ë¯¸ì§€ ìƒì„±
  useState(() => {
    const canvas = canvasRef.current;
    if (!canvas) {
      console.warn("canvas is not found");
      return;
    }
    setTimeout(() => drawGradientImage(canvas), 1000);
  });

  return (
    <Card>
      <Flex direction="column" gap="4">
        <Text size="4" weight="bold">
          ì´ë¯¸ì§€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        </Text>

        <Text size="2" color="gray">
          Canvasë‚˜ SVGë¡œ ìƒì„±ëœ ì´ë¯¸ì§€ë¥¼ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </Text>

        <Flex direction="column" gap="3">
          <Flex direction="column" gap="2">
            <Text size="2" weight="medium">
              íŒŒì¼ëª…:
            </Text>
            <TextField.Root
              value={filename}
              onChange={(e) => setFilename(e.target.value)}
              placeholder="ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."
            />
          </Flex>

          <Flex direction="column" gap="2" align="center">
            <canvas
              ref={canvasRef}
              style={{
                border: "2px solid var(--gray-6)",
                borderRadius: "8px",
                maxWidth: "100%",
                height: "auto",
              }}
            />

            <Flex gap="2" wrap="wrap" justify="center">
              <Button
                variant="soft"
                size="1"
                onClick={() => generateAndDrawImage("gradient")}
              >
                ê·¸ë¼ë””ì–¸íŠ¸
              </Button>
              <Button
                variant="soft"
                size="1"
                onClick={() => generateAndDrawImage("chart")}
              >
                ì°¨íŠ¸
              </Button>
              <Button
                variant="soft"
                size="1"
                onClick={() => generateAndDrawImage("pattern")}
              >
                íŒ¨í„´
              </Button>
              <Button
                variant="soft"
                size="1"
                onClick={() => generateAndDrawImage("qr")}
              >
                QR ìŠ¤íƒ€ì¼
              </Button>
            </Flex>

            <Flex gap="2" align="center" wrap="wrap">
              <Button onClick={handleDownloadCanvas}>PNG ë‹¤ìš´ë¡œë“œ</Button>
              <Button onClick={downloadSVGImage} variant="soft">
                SVG ë‹¤ìš´ë¡œë“œ
              </Button>

              {downloadStatus && (
                <Badge
                  color={downloadStatus.includes("ì„±ê³µ") ? "green" : "red"}
                >
                  {downloadStatus}
                </Badge>
              )}
            </Flex>
          </Flex>

          <Card variant="surface">
            <Flex direction="column" gap="2">
              <Text size="2" weight="medium">
                ğŸ’¡ ì‚¬ìš© ë°©ë²•:
              </Text>
              <Text size="2" color="gray">
                1. ìœ„ì˜ ë²„íŠ¼ë“¤ë¡œ ë‹¤ì–‘í•œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ë³´ì„¸ìš”
              </Text>
              <Text size="2" color="gray">
                2. ì›í•˜ëŠ” íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (.png ë˜ëŠ” .svg)
              </Text>
              <Text size="2" color="gray">
                3. "PNG ë‹¤ìš´ë¡œë“œ" ë˜ëŠ” "SVG ë‹¤ìš´ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
              </Text>
              <Text size="2" color="gray">
                4. ë¸Œë¼ìš°ì €ì˜ ë‹¤ìš´ë¡œë“œ í´ë”ì—ì„œ íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”
              </Text>
            </Flex>
          </Card>
        </Flex>
      </Flex>
    </Card>
  );
}
